# Variables
NAMESPACE=default
SERVICE_ACCOUNT=fuconfig-service-account
CONTEXT=$(kubectl config current-context)
SECRET_NAME=$(kubectl get serviceaccount $SERVICE_ACCOUNT -n $NAMESPACE -o jsonpath='{.secrets[0].name}')
CA=$(kubectl get secret $SECRET_NAME -n $NAMESPACE -o jsonpath='{.data.ca\.crt}' | base64 --decode)
TOKEN=$(kubectl get secret $SECRET_NAME -n $NAMESPACE -o jsonpath='{.data.token}' | base64 --decode)
NAMESPACE=$(kubectl get secret $SECRET_NAME -n $NAMESPACE -o jsonpath='{.data.namespace}' | base64 --decode)

# Generate kubeconfig
cat <<EOF > kubeconfig
apiVersion: v1
kind: Config
clusters:
- cluster:
    certificate-authority-data: $(kubectl config view --raw -o jsonpath="{.clusters[?(@.name==\"$CONTEXT\")].cluster.certificate-authority-data}")
    server: $(kubectl config view --raw -o jsonpath="{.clusters[?(@.name==\"$CONTEXT\")].cluster.server}")
  name: kubernetes
contexts:
- context:
    cluster: kubernetes
    namespace: $NAMESPACE
    user: $SERVICE_ACCOUNT
  name: $SERVICE_ACCOUNT@kubernetes
current-context: $SERVICE_ACCOUNT@kubernetes
users:
- name: $SERVICE_ACCOUNT
  user:
    token: $TOKEN
EOF
